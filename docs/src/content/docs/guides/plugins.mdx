---
title: 编写插件
description: 学习如何编写一个插件
---

import { Steps } from '@astrojs/starlight/components';

编写一个插件是很简单的，但是借助内核暴露出来的`钩子`和 `API`，你可以很轻松的实现强大且定制化的需求。由于内核没有暴漏出来**根据关键字（或者其他）来实现过滤弹幕**的功能，原因在于内核不知道弹幕内容的数据结构，这和业务的诉求强相关，所以我们在此通过插件来实现这一功能以演示如何编写一个插件。

## 编写过滤插件

这里是根据特殊条件来选择性的过滤一些弹幕，当然你可以随机取一定的比例过滤，这在一些视频网站上很常见，是一种实现**精简弹幕**的方式。

<Steps>
1. **编写一个插件**

    :::note[编写插件注意事项]
     - 你编写的插件应当取一个名字，以便于 debug。
     - 插件可以选择性的声明一个 `version`，这在你的插件作为独立包发到 `npm` 上时很有用。
    :::

    ```ts {10, 14}
    export function filter({ userIds, keywords }) {
      return (manager) => {
        return {
          name: 'filter-keywords-or-user',
          version: '1.0.0', // version 字段不是必须的
          willRender(ref) {
            const { userId, content } = ref.danmaku.data.value;
            console.log(ref.type); // 可以根据此字段来区分是普通弹幕还是高级弹幕

            if (userIds && userIds.includes(userId)) {
              ref.prevent = true;
            } else if (keywords) {
              for (const word of keywords) {
                if (content.includes(word)) {
                  ref.prevent = true;
                  break;
                }
              }
            }
            return ref;
          },
        }
      }
    }
    ```

2.  **注册使用插件**

    你需要通过 `mananger.use()` 来注册插件。

    ```ts {6-9}
    import { create } from 'danmu';

    const manager = create();

    manager.use(
      filter({
        userIds: [1],
        keywords: ['菜'],
      }),
    );
    ```

3.  **发送弹幕**

    下面是一些发送弹幕的 case。

    ```ts {3, 9, 16, 22}
    // 会被插件阻止渲染
    manager.push({
      userId: 1,
      content: '',
    });

    // 不会被插件阻止渲染
    manager.push({
      userId: 2,
      content: '',
    });

    // 会被插件阻止渲染
    manager.push({
      userId: 2,
      content: '你真菜',
    });

    // 不会被插件阻止渲染
    manager.push({
      userId: 2,
      content: '你真棒',
    });
    ```

</Steps>
